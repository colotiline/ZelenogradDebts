var wasChanged=!1,flatsArray=[],chartData={},chartCanvas={},updateChart=function(){chartCanvas.Bar(chartData,{responsive:!0,tooltipTemplate:"<%if (label){%><%=label%>: <%}%><%= $.number(value, 2, ',', ' ') %>"}),$("#debts-chart-bar").width($(".col-xs-12").width())},dataRefresh=function(){var t=$("#debts-filter").val(),e=parseFloat($("#debts-filter-min").val()),a=parseFloat($("#debts-filter-max").val()),s=$.parseJSON(data);t&&(s=$.grep(s,function(e){return-1!==e.Street.indexOf(t)})),e&&$.each(s,function(t,a){a.Flats=$.grep(a.Flats,function(t){return parseFloat(t.Debt)>e})}),a&&$.each(s,function(t,e){e.Flats=$.grep(e.Flats,function(t){return parseFloat(t.Debt)<a})}),(e||a)&&(s=$.grep(s,function(t){return t.Flats.length>0})),$("#debts-blocks-quantity").text(s.length);var r=0,n=0;flatsArray=[];var l=[];chartData={labels:[],datasets:[{data:[]}]},$.each(s,function(t,e){r+=e.Flats.length;var a=0;$.each(e.Flats,function(t,s){s.Street=e.Street,flatsArray.push(s),a+=s.Debt,n+=s.Debt,l.push(s.Debt)}),e.DebtsSum=a,chartData.labels.push(e.Street),chartData.datasets[0].data.push(a)}),wasChanged?updateChart():(chartCanvas=new Chart($("#debts-chart-bar").get(0).getContext("2d")),wasChanged=!0);var d=5,b=s.sort(function(t,e){return parseFloat(e.DebtsSum)-parseFloat(t.DebtsSum)}).slice(0,d),o=flatsArray.sort(function(t,e){return parseFloat(e.Debt)-parseFloat(t.Debt)}).slice(0,d);$("#debts-list tr.removable").remove(),$("#debts-flats-quantity").text(r),$("#debts-sum").text($.number(n,2,","," ")),l.length>0?($("#debts-avg").text($.number(math.sum(l)/l.length,2,","," ")),$("#debts-median").text($.number(math.median(l),2,","," ")),$("#debts-max").text($.number(math.max(l),2,","," "))):($("#debts-avg").text($.number(0,2,","," ")),$("#debts-median").text($.number(0,2,","," ")),$("#debts-max").text($.number(0,2,","," "))),$("#debts-blocks-top tr.removable").remove(),$.each(b,function(t,e){$("#debts-blocks-top > tbody:last").append('<tr class="removable"><td>'+e.Street+"</td><td>"+$.number(e.DebtsSum,2,","," ")+' <span class="fa fa-ruble"></span></td></tr>')}),$("#debts-flats-top tr.removable").remove(),$.each(o,function(t,e){$("#debts-flats-top > tbody:last").append('<tr class="removable"><td>'+e.Street+", "+e.Flat+"</td><td>"+$.number(e.Debt,2,","," ")+' <span class="fa fa-ruble"></span></td></tr>')})};dataRefresh(),$("#debts-button-display-all").click(function(){Pace.restart(),$("#debts-button-display-all").addClass("disabled"),setTimeout(function(){$.each(flatsArray,function(t,e){$("#debts-list > tbody:last").append('<tr class="removable"><td>'+e.Street+", "+e.Flat+"</td><td>"+$.number(e.Debt,2,","," ")+' <span class="fa fa-ruble"></span></td></tr>')}),Pace.stop(),$("#debts-button-display-all").removeClass("disabled")},200)}),$("#debts-button-display-chart").click(function(){wasChanged||(chartCanvas=new Chart($("#debts-chart-bar").get(0).getContext("2d"))),updateChart(),wasChanged=!0}),$("#debts-button-filter").click(function(){dataRefresh()}),$("#debts-button-filter-max").click(function(){dataRefresh()}),$("#debts-button-filter-min").click(function(){dataRefresh()}),$("#debts-filter").keypress(function(t){13===t.keyCode&&dataRefresh()}),$("#debts-filter-max").keypress(function(t){13===t.keyCode&&dataRefresh()}),$("#debts-filter-min").keypress(function(t){13===t.keyCode&&dataRefresh()});